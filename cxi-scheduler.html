<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CXI Scheduling Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f14;
    --surface: #13161d;
    --surface2: #1a1e28;
    --border: #252a38;
    --accent: #00e5a0;
    --accent2: #0085ff;
    --warn: #ff6b35;
    --text: #e8eaf0;
    --muted: #6b7280;
    --karl: #00e5a0;
    --josh: #0085ff;
    --david: #a855f7;
    --unassigned: #ff6b35;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,160,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,160,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 960px;
    margin: 0 auto;
    padding: 40px 24px;
  }

  /* Header */
  header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 48px;
  }

  .logo-mark {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: 800;
    color: #0d0f14;
    flex-shrink: 0;
    letter-spacing: -1px;
  }

  .header-text h1 {
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.5px;
    line-height: 1;
  }

  .header-text p {
    font-size: 13px;
    color: var(--muted);
    margin-top: 4px;
    font-family: 'DM Mono', monospace;
  }

  .badge {
    margin-left: auto;
    background: rgba(0,229,160,0.1);
    border: 1px solid rgba(0,229,160,0.25);
    color: var(--accent);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 20px;
    letter-spacing: 0.5px;
  }

  /* API Key Section */
  .api-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .section-label {
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .api-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .api-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }

  .api-input:focus {
    border-color: var(--accent);
  }

  .api-input::placeholder { color: var(--muted); }

  .btn {
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13px;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }

  .btn-save {
    background: var(--accent);
    color: #0d0f14;
  }

  .btn-save:hover { background: #00ffb3; transform: translateY(-1px); }

  .btn-clear {
    background: var(--surface2);
    color: var(--muted);
    border: 1px solid var(--border);
  }

  .btn-clear:hover { color: var(--warn); border-color: var(--warn); }

  .key-status {
    margin-top: 10px;
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .key-status.ok { color: var(--accent); }
  .key-status.missing { color: var(--warn); }

  .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
    display: inline-block;
  }

  /* Upload Section */
  .upload-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
  }

  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--accent);
    background: rgba(0,229,160,0.04);
  }

  .drop-zone input[type=file] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .drop-icon {
    font-size: 36px;
    margin-bottom: 12px;
    display: block;
  }

  .drop-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .drop-sub {
    font-size: 13px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
  }

  .file-loaded {
    background: rgba(0,229,160,0.08);
    border: 1px solid rgba(0,229,160,0.2);
    border-radius: 10px;
    padding: 12px 16px;
    margin-top: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-family: 'DM Mono', monospace;
  }

  .file-loaded .file-icon { font-size: 18px; }
  .file-loaded .file-name { color: var(--accent); flex: 1; }
  .file-loaded .file-size { color: var(--muted); }

  /* Date selector */
  .date-row {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 16px;
  }

  .date-label {
    font-size: 13px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    white-space: nowrap;
  }

  .date-input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    color-scheme: dark;
  }

  .date-input:focus { border-color: var(--accent); }

  /* Generate Button */
  .btn-generate {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #0d0f14;
    border: none;
    border-radius: 12px;
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
  }

  .btn-generate:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0,229,160,0.3);
  }

  .btn-generate:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  .btn-generate .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(13,15,20,0.3);
    border-top-color: #0d0f14;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Status / Progress */
  .status-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    display: none;
  }

  .status-bar.visible { display: flex; }
  .status-bar.thinking { border-color: rgba(0,133,255,0.3); color: var(--accent2); }
  .status-bar.done { border-color: rgba(0,229,160,0.3); color: var(--accent); }
  .status-bar.error { border-color: rgba(255,107,53,0.3); color: var(--warn); }

  .thinking-dots span {
    animation: blink 1.4s infinite;
    opacity: 0;
  }
  .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%,80%,100%{opacity:0} 40%{opacity:1} }

  /* Results */
  #results { display: none; }
  #results.visible { display: block; }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .results-title {
    font-size: 18px;
    font-weight: 800;
    letter-spacing: -0.3px;
  }

  .results-meta {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--muted);
  }

  .btn-copy-all {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 16px;
    border-radius: 8px;
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-copy-all:hover { border-color: var(--accent); color: var(--accent); }

  /* Tech Cards */
  .tech-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 20px;
    overflow: hidden;
    animation: slideUp 0.4s ease forwards;
    opacity: 0;
    transform: translateY(16px);
  }

  @keyframes slideUp {
    to { opacity: 1; transform: translateY(0); }
  }

  .tech-card:nth-child(1) { animation-delay: 0.05s; }
  .tech-card:nth-child(2) { animation-delay: 0.1s; }
  .tech-card:nth-child(3) { animation-delay: 0.15s; }
  .tech-card:nth-child(4) { animation-delay: 0.2s; }

  .tech-header {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border);
  }

  .tech-avatar {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 14px;
    color: #0d0f14;
    flex-shrink: 0;
  }

  .avatar-karl { background: var(--karl); }
  .avatar-josh { background: var(--josh); }
  .avatar-david { background: var(--david); }
  .avatar-unassigned { background: var(--unassigned); }

  .tech-name {
    font-size: 16px;
    font-weight: 700;
  }

  .tech-job-count {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }

  .btn-copy-tech {
    margin-left: auto;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 6px 12px;
    border-radius: 7px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-copy-tech:hover { border-color: var(--accent); color: var(--accent); }

  /* Schedule Table */
  .table-wrap {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead tr {
    background: var(--surface2);
  }

  thead th {
    padding: 10px 16px;
    text-align: left;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.8px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }

  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(255,255,255,0.02); }

  tbody td {
    padding: 12px 16px;
    vertical-align: top;
    line-height: 1.5;
  }

  .order-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    font-weight: 500;
    color: var(--muted);
  }

  .priority-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    font-weight: 500;
    white-space: nowrap;
  }

  .priority-urgent {
    background: rgba(255,107,53,0.15);
    color: var(--warn);
    border: 1px solid rgba(255,107,53,0.25);
  }

  .priority-high {
    background: rgba(255,193,7,0.12);
    color: #ffd60a;
    border: 1px solid rgba(255,193,7,0.2);
  }

  .priority-normal {
    background: rgba(107,114,128,0.15);
    color: var(--muted);
    border: 1px solid var(--border);
  }

  .priority-sla {
    background: rgba(0,229,160,0.12);
    color: var(--accent);
    border: 1px solid rgba(0,229,160,0.25);
  }

  .task-title { font-weight: 600; color: var(--text); }
  .task-sub { color: var(--muted); font-size: 12px; margin-top: 2px; font-family: 'DM Mono', monospace; }

  /* Raw output for copy */
  .raw-output {
    display: none;
  }

  /* Footer */
  footer {
    text-align: center;
    padding: 32px 0 16px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    border-top: 1px solid var(--border);
    margin-top: 40px;
  }

  footer span { color: var(--accent); }

  /* Responsive */
  @media (max-width: 600px) {
    .api-row { flex-direction: column; }
    .btn { width: 100%; }
    .date-row { flex-direction: column; align-items: flex-start; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header>
    <div class="logo-mark">CXI</div>
    <div class="header-text">
      <h1>Scheduling Assistant</h1>
      <p>AroFlo Job Scheduler â€” Powered by AI</p>
    </div>
    <div class="badge">v1.0</div>
  </header>

  <!-- API Key -->
  <div class="api-section">
    <div class="section-label">Anthropic API Key</div>
    <div class="api-row">
      <input type="password" class="api-input" id="apiKey" placeholder="sk-ant-..." autocomplete="off" />
      <button class="btn btn-save" onclick="saveKey()">Save Key</button>
      <button class="btn btn-clear" onclick="clearKey()">Clear</button>
    </div>
    <div class="key-status missing" id="keyStatus">
      <span class="dot"></span> No API key saved â€” enter your key above
    </div>
  </div>

  <!-- Upload -->
  <div class="upload-section">
    <div class="section-label">AroFlo Task Export</div>
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" onchange="handleFile(event)" />
      <span class="drop-icon">ðŸ“‹</span>
      <div class="drop-title">Drop your AroFlo export here</div>
      <div class="drop-sub">Accepts CSV or Excel files (.csv, .xlsx, .xls)</div>
    </div>
    <div class="file-loaded" id="fileLoaded" style="display:none">
      <span class="file-icon">âœ…</span>
      <span class="file-name" id="fileName"></span>
      <span class="file-size" id="fileSize"></span>
    </div>
    <div class="date-row">
      <span class="date-label">Schedule date:</span>
      <input type="date" class="date-input" id="schedDate" />
    </div>
  </div>

  <!-- Generate Button -->
  <button class="btn-generate" id="generateBtn" onclick="generateSchedule()" disabled>
    Generate Schedule
  </button>

  <!-- Status -->
  <div class="status-bar" id="statusBar">
    <span id="statusIcon">âš¡</span>
    <span id="statusText">Processing...</span>
    <span class="thinking-dots" id="thinkingDots" style="display:none">
      <span>.</span><span>.</span><span>.</span>
    </span>
  </div>

  <!-- Results -->
  <div id="results">
    <div class="results-header">
      <div>
        <div class="results-title">Schedule Generated</div>
        <div class="results-meta" id="resultsMeta"></div>
      </div>
      <button class="btn-copy-all" onclick="copyAll()">ðŸ“‹ Copy All Tables</button>
    </div>
    <div id="techCards"></div>
  </div>

  <footer>
    CXI AroFlo Scheduling Assistant &nbsp;Â·&nbsp; Built for <span>CXI</span> &nbsp;Â·&nbsp; Karl Â· Josh Â· David
  </footer>

</div>

<!-- Hidden raw output -->
<div class="raw-output" id="rawOutput"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let fileData = null;
let fileName = '';

// â”€â”€â”€ On Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  const saved = sessionStorage.getItem('cxi_api_key');
  if (saved) {
    document.getElementById('apiKey').value = saved;
    showKeyStatus(true);
  }
  // Default date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('schedDate').value = today;

  checkReady();

  // Drag-drop
  const dz = document.getElementById('dropZone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', e => {
    e.preventDefault();
    dz.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) processFile(file);
  });
});

// â”€â”€â”€ API Key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveKey() {
  const key = document.getElementById('apiKey').value.trim();
  if (!key.startsWith('sk-ant-')) {
    alert('That doesn\'t look like a valid Anthropic API key. It should start with sk-ant-');
    return;
  }
  sessionStorage.setItem('cxi_api_key', key);
  showKeyStatus(true);
  checkReady();
}

function clearKey() {
  sessionStorage.removeItem('cxi_api_key');
  document.getElementById('apiKey').value = '';
  showKeyStatus(false);
  checkReady();
}

function showKeyStatus(ok) {
  const el = document.getElementById('keyStatus');
  if (ok) {
    el.className = 'key-status ok';
    el.innerHTML = '<span class="dot"></span> API key saved for this session';
  } else {
    el.className = 'key-status missing';
    el.innerHTML = '<span class="dot"></span> No API key saved â€” enter your key above';
  }
}

// â”€â”€â”€ File Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFile(event) {
  const file = event.target.files[0];
  if (file) processFile(file);
}

function processFile(file) {
  fileName = file.name;
  const size = file.size < 1024 ? file.size + ' B' : (file.size / 1024).toFixed(1) + ' KB';

  const reader = new FileReader();

  if (file.name.endsWith('.csv')) {
    reader.onload = e => {
      fileData = e.target.result;
      showFileLoaded(file.name, size);
    };
    reader.readAsText(file);
  } else {
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        fileData = XLSX.utils.sheet_to_csv(ws);
        showFileLoaded(file.name, size);
      } catch(err) {
        alert('Could not read that file. Please export from AroFlo as CSV or Excel.');
      }
    };
    reader.readAsArrayBuffer(file);
  }
}

function showFileLoaded(name, size) {
  document.getElementById('fileLoaded').style.display = 'flex';
  document.getElementById('fileName').textContent = name;
  document.getElementById('fileSize').textContent = size;
  checkReady();
}

// â”€â”€â”€ Button State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkReady() {
  const hasKey = !!sessionStorage.getItem('cxi_api_key');
  const hasFile = !!fileData;
  document.getElementById('generateBtn').disabled = !(hasKey && hasFile);
}

// â”€â”€â”€ Generate Schedule â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateSchedule() {
  const key = sessionStorage.getItem('cxi_api_key');
  const schedDate = document.getElementById('schedDate').value;
  const dateLabel = schedDate ? new Date(schedDate + 'T00:00:00').toLocaleDateString('en-AU', { weekday:'long', day:'numeric', month:'long', year:'numeric' }) : 'Today';

  setStatus('thinking', 'âš¡', 'Sending jobs to AI for analysis');
  document.getElementById('generateBtn').disabled = true;
  document.getElementById('results').classList.remove('visible');

  const systemPrompt = `You are the CXI AroFlo Scheduling Assistant. Your job is to read a list of open tasks exported from AroFlo and assign them to technicians based on strict rules.

TECHNICIAN PROFILES:

Karl:
- Skills: Inner Range Inception, Inner Range Integriti, Intercoms (All), Troubleshooting service work, CCTV (all), NX Witness, ProtÃ©gÃ© WX, ProtÃ©gÃ© GX
- Certifications: Inner Range Integriti Base level
- Zone: ACT
- Hours: 08:00â€“16:30

Josh:
- Skills: Inner Range Inception, Hikvision CCTV, CCTV (Some), NX Witness, Troubleshooting Service work, Cabling and installation, NCH and TCH (North Canberra Hospital and The Canberra Hospital)
- Certifications: Inner Range Inception, ProtÃ©gÃ© WX
- Zone: ACT
- Hours: 08:00â€“16:30

David:
- Skills: Inner Range Inception, Inner Range Integriti, Intercoms (All), Troubleshooting service work, CCTV (all), NX Witness, ProtÃ©gÃ© WX, QPRC Sites (all Queanbeyan Palerang Regional Council work)
- Certifications: Inner Range Integriti advanced, NCH and TCH (North Canberra Hospital and The Canberra Hospital)
- Zone: ACT (prefers North side)
- Hours: 08:00â€“16:30

SKILL ASSIGNMENT RULES:
- Integriti jobs â†’ ONLY Karl or David
- Advanced CCTV jobs â†’ ONLY Karl or David
- Electrical tasks â†’ ONLY Kristian (if Kristian is unavailable, add to Unassigned)
- NCH or TCH jobs â†’ ONLY David or Josh
- ProtÃ©gÃ© GX jobs â†’ ONLY Karl
- Access control jobs â†’ techs with EAC competency only
- CCTV jobs â†’ techs with IP networking + camera config skills
- Intercom jobs â†’ techs with cabling + handset experience
- CCTV footage review â†’ basic CCTV skills sufficient

GEOGRAPHIC RULES:
- Keep North-side techs north for end-of-day jobs (David prefers north)
- Keep South-side techs south for end-of-day jobs
- Minimise cross-city travel
- Group jobs by suburb or radius (try to keep within 5â€“10 km)
- Prioritise shortest travel path, avoid backtracking

WORKLOAD RULES:
- Max 6 jobs per technician per day
- Max 30 minutes travel time per technician
- Try to keep job sequencing within 5â€“10 km radius

PRIORITY RULES:
- SLA or urgent tasks override geographic grouping
- Prevent low-priority tasks from blocking high-priority availability

OUTPUT FORMAT â€” You MUST respond with a valid JSON object only. No explanation, no markdown, no extra text. Just the JSON.

The JSON must follow this exact structure:
{
  "scheduleDate": "string",
  "summary": "brief one-line summary of the day",
  "technicians": [
    {
      "name": "Karl",
      "jobs": [
        {
          "order": 1,
          "taskId": "string",
          "client": "string",
          "location": "string",
          "description": "string",
          "priority": "Urgent|High|Normal|SLA",
          "estimatedDuration": "string",
          "notes": "string"
        }
      ]
    }
  ],
  "unassigned": [
    {
      "taskId": "string",
      "client": "string",
      "location": "string",
      "description": "string",
      "reason": "string"
    }
  ]
}

Only include technicians who have jobs assigned. Always include unassigned array (empty if none).`;

  const userMessage = `Please schedule the following AroFlo open tasks for ${dateLabel}. Apply all skill, geographic, workload and priority rules.

Here is the task data:

${fileData}`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-opus-4-5-20251101',
        max_tokens: 4096,
        system: systemPrompt,
        messages: [{ role: 'user', content: userMessage }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'API request failed');
    }

    const data = await response.json();
    const rawText = data.content[0].text;

    // Parse JSON from response
    let schedule;
    try {
      // Strip any possible markdown fences
      const clean = rawText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      schedule = JSON.parse(clean);
    } catch(e) {
      throw new Error('Could not parse the AI response. Please try again.');
    }

    setStatus('done', 'âœ…', `Schedule generated â€” ${dateLabel}`);
    renderResults(schedule, dateLabel);

  } catch(err) {
    setStatus('error', 'âŒ', 'Error: ' + err.message);
    document.getElementById('generateBtn').disabled = false;
  }
}

// â”€â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(type, icon, text) {
  const bar = document.getElementById('statusBar');
  bar.className = 'status-bar visible ' + type;
  document.getElementById('statusIcon').textContent = icon;
  document.getElementById('statusText').textContent = text;
  document.getElementById('thinkingDots').style.display = type === 'thinking' ? 'inline' : 'none';
}

// â”€â”€â”€ Render Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(schedule, dateLabel) {
  const results = document.getElementById('results');
  const cards = document.getElementById('techCards');
  const meta = document.getElementById('resultsMeta');

  const totalJobs = (schedule.technicians || []).reduce((a,t) => a + t.jobs.length, 0);
  const unassignedCount = (schedule.unassigned || []).length;
  meta.textContent = `${dateLabel} Â· ${totalJobs} jobs assigned Â· ${unassignedCount} unassigned`;

  cards.innerHTML = '';

  // Tech cards
  const techColors = { Karl: 'karl', Josh: 'josh', David: 'david' };

  (schedule.technicians || []).forEach(tech => {
    const initial = tech.name.charAt(0).toUpperCase();
    const colorClass = 'avatar-' + (techColors[tech.name] || 'karl');

    const rows = tech.jobs.map(job => {
      const priorityClass = {
        'Urgent': 'priority-urgent',
        'High': 'priority-high',
        'SLA': 'priority-sla',
        'Normal': 'priority-normal'
      }[job.priority] || 'priority-normal';

      return `<tr>
        <td><span class="order-badge">${job.order}</span></td>
        <td>
          <div class="task-title">${escHtml(job.taskId || '')}</div>
          <div class="task-sub">${escHtml(job.estimatedDuration || '')}</div>
        </td>
        <td>
          <div class="task-title">${escHtml(job.client || '')}</div>
          <div class="task-sub">${escHtml(job.location || '')}</div>
        </td>
        <td>${escHtml(job.description || '')}</td>
        <td><span class="priority-badge ${priorityClass}">${escHtml(job.priority || 'Normal')}</span></td>
        <td class="task-sub">${escHtml(job.notes || 'â€”')}</td>
      </tr>`;
    }).join('');

    const card = document.createElement('div');
    card.className = 'tech-card';
    card.innerHTML = `
      <div class="tech-header">
        <div class="tech-avatar ${colorClass}">${initial}</div>
        <div>
          <div class="tech-name">${escHtml(tech.name)}</div>
          <div class="tech-job-count">${tech.jobs.length} job${tech.jobs.length !== 1 ? 's' : ''} assigned</div>
        </div>
        <button class="btn-copy-tech" onclick="copyTechTable('${escHtml(tech.name)}')">ðŸ“‹ Copy Table</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>#</th><th>Task ID</th><th>Client / Location</th>
            <th>Description</th><th>Priority</th><th>Notes</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
    cards.appendChild(card);
  });

  // Unassigned card
  if (schedule.unassigned && schedule.unassigned.length > 0) {
    const rows = schedule.unassigned.map(job => `<tr>
      <td>
        <div class="task-title">${escHtml(job.taskId || '')}</div>
      </td>
      <td>
        <div class="task-title">${escHtml(job.client || '')}</div>
        <div class="task-sub">${escHtml(job.location || '')}</div>
      </td>
      <td>${escHtml(job.description || '')}</td>
      <td style="color:var(--warn)">${escHtml(job.reason || '')}</td>
    </tr>`).join('');

    const card = document.createElement('div');
    card.className = 'tech-card';
    card.innerHTML = `
      <div class="tech-header">
        <div class="tech-avatar avatar-unassigned">!</div>
        <div>
          <div class="tech-name">Unassigned Jobs</div>
          <div class="tech-job-count">${schedule.unassigned.length} job${schedule.unassigned.length !== 1 ? 's' : ''} could not be assigned</div>
        </div>
        <button class="btn-copy-tech" onclick="copyTechTable('Unassigned')">ðŸ“‹ Copy Table</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Task ID</th><th>Client / Location</th><th>Description</th><th>Reason Unassigned</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
    cards.appendChild(card);
  }

  // Store raw CSV-style for copy
  storeRawOutput(schedule, dateLabel);

  results.classList.add('visible');
  document.getElementById('generateBtn').disabled = false;
  document.getElementById('generateBtn').textContent = 'â†º Generate New Schedule';
  results.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// â”€â”€â”€ Raw Output for Copying â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function storeRawOutput(schedule, dateLabel) {
  let text = `CXI SCHEDULE â€” ${dateLabel}\n${'='.repeat(60)}\n\n`;

  (schedule.technicians || []).forEach(tech => {
    text += `TECHNICIAN: ${tech.name.toUpperCase()}\n${'-'.repeat(40)}\n`;
    text += `#\tTask ID\tClient\tLocation\tDescription\tPriority\tNotes\n`;
    tech.jobs.forEach(job => {
      text += `${job.order}\t${job.taskId||''}\t${job.client||''}\t${job.location||''}\t${job.description||''}\t${job.priority||''}\t${job.notes||''}\n`;
    });
    text += '\n';
  });

  if (schedule.unassigned && schedule.unassigned.length > 0) {
    text += `UNASSIGNED JOBS\n${'-'.repeat(40)}\n`;
    text += `Task ID\tClient\tLocation\tDescription\tReason\n`;
    schedule.unassigned.forEach(job => {
      text += `${job.taskId||''}\t${job.client||''}\t${job.location||''}\t${job.description||''}\t${job.reason||''}\n`;
    });
  }

  document.getElementById('rawOutput').textContent = text;
}

function copyAll() {
  const text = document.getElementById('rawOutput').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.btn-copy-all');
    btn.textContent = 'âœ… Copied!';
    setTimeout(() => btn.textContent = 'ðŸ“‹ Copy All Tables', 2000);
  });
}

function copyTechTable(techName) {
  const raw = document.getElementById('rawOutput').textContent;
  // Extract just that technician's section
  const lines = raw.split('\n');
  let capture = false;
  let section = [];

  for (const line of lines) {
    if (line.includes(`TECHNICIAN: ${techName.toUpperCase()}`) || line.includes(`UNASSIGNED JOBS`) && techName === 'Unassigned') {
      capture = true;
    }
    if (capture) {
      if (line.startsWith('TECHNICIAN:') && !line.includes(techName.toUpperCase()) && section.length > 0) break;
      section.push(line);
    }
  }

  navigator.clipboard.writeText(section.join('\n')).then(() => {
    // Visual feedback
    const btns = document.querySelectorAll('.btn-copy-tech');
    btns.forEach(btn => {
      if (btn.getAttribute('onclick').includes(techName)) {
        btn.textContent = 'âœ… Copied!';
        setTimeout(() => btn.textContent = 'ðŸ“‹ Copy Table', 2000);
      }
    });
  });
}

function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

</script>
</body>
</html>
