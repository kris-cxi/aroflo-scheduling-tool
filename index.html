<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CXI ‚Äî Scheduling Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --orange:      #e8631a;
    --orange-dark: #c9530e;
    --navy:        #1c2640;
    --navy-dark:   #141c30;
    --white:       #ffffff;
    --off-white:   #f7f8fa;
    --border:      #e4e7ef;
    --text:        #1c2640;
    --text-mid:    #4a5268;
    --text-light:  #8a91a8;
    --success:     #1a7a50;
    --success-bg:  #edf7f2;
    --success-bd:  #b2dece;
    --david:       #1c2640;
    --karl:        #0066b3;
    --josh:        #5a7fa8;
    --unassigned:  #e8631a;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--white);
    color: var(--text);
    font-size: 15px;
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ Announcement bar ‚îÄ‚îÄ */
  .announce {
    background: var(--navy);
    color: rgba(255,255,255,0.7);
    text-align: center;
    font-size: 12px;
    padding: 6px 16px;
    letter-spacing: 0.2px;
  }
  .announce b { color: var(--orange); font-weight: 600; }

  /* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
  nav {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    height: 66px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  }

  .nav-brand {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  /* Logo mark matching CXI style */
  .logo-mark {
    width: 36px;
    height: 36px;
    background: var(--navy);
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .logo-mark svg { display: block; }

  .logo-text {
    display: flex;
    flex-direction: column;
    line-height: 1.1;
  }

  .logo-text .l1 {
    font-size: 16px;
    font-weight: 700;
    color: var(--navy);
    letter-spacing: 0.5px;
  }

  .logo-text .l2 {
    font-size: 9.5px;
    font-weight: 500;
    color: var(--text-light);
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  .nav-pipe {
    width: 1px;
    height: 28px;
    background: var(--border);
  }

  .nav-pagetitle {
    font-size: 13.5px;
    font-weight: 500;
    color: var(--text-mid);
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .nav-phone {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-mid);
    text-decoration: none;
  }

  .nav-btn {
    height: 36px;
    padding: 0 18px;
    background: var(--orange);
    color: #fff;
    border: none;
    border-radius: 4px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    transition: background 0.15s;
  }
  .nav-btn:hover { background: var(--orange-dark); }

  /* ‚îÄ‚îÄ Hero ‚îÄ‚îÄ */
  .hero {
    background: var(--off-white);
    border-bottom: 1px solid var(--border);
    padding: 44px 40px 36px;
  }

  .hero-inner { max-width: 860px; margin: 0 auto; }

  .hero-label {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2.2px;
    text-transform: uppercase;
    color: var(--orange);
    margin-bottom: 8px;
  }

  .hero-h1 {
    font-size: 30px;
    font-weight: 700;
    color: var(--navy);
    letter-spacing: -0.3px;
    line-height: 1.2;
    margin-bottom: 10px;
  }

  .hero-p {
    font-size: 15px;
    color: var(--text-mid);
    max-width: 540px;
    line-height: 1.65;
  }

  /* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
  .content {
    max-width: 860px;
    margin: 0 auto;
    padding: 36px 40px 80px;
  }

  /* ‚îÄ‚îÄ Panel ‚îÄ‚îÄ */
  .panel {
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 26px 26px 22px;
    margin-bottom: 20px;
    background: var(--white);
  }

  .panel-head {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1.8px;
    text-transform: uppercase;
    color: var(--text-light);
    margin-bottom: 14px;
  }

  /* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
  .row { display: flex; gap: 10px; align-items: center; }

  .inp {
    flex: 1;
    height: 42px;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0 14px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--text);
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .inp:focus {
    border-color: var(--orange);
    box-shadow: 0 0 0 3px rgba(232,99,26,0.1);
  }
  .inp::placeholder { color: var(--text-light); }

  .btn {
    height: 42px;
    padding: 0 20px;
    border: none;
    border-radius: 4px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .btn-primary { background: var(--navy); color: #fff; }
  .btn-primary:hover { background: #263660; }

  .btn-outline {
    background: transparent;
    color: var(--text-mid);
    border: 1px solid var(--border);
  }
  .btn-outline:hover { border-color: var(--text-mid); color: var(--text); }

  .key-note {
    margin-top: 8px;
    font-size: 12.5px;
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-light);
  }
  .key-note.ok { color: var(--success); }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }

  /* ‚îÄ‚îÄ Drop zone ‚îÄ‚îÄ */
  .dropzone {
    border: 1.5px dashed var(--border);
    border-radius: 5px;
    padding: 36px 20px;
    text-align: center;
    background: var(--off-white);
    cursor: pointer;
    position: relative;
    transition: all 0.15s;
  }
  .dropzone:hover, .dropzone.over {
    border-color: var(--orange);
    background: #fff8f4;
  }
  .dropzone input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }
  .dz-icon { font-size: 28px; margin-bottom: 8px; display: block; }
  .dz-title { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
  .dz-hint  { font-size: 12.5px; color: var(--text-light); }

  .file-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--success-bg);
    border: 1px solid var(--success-bd);
    border-radius: 4px;
    padding: 7px 14px;
    font-size: 13px;
    margin-top: 12px;
  }
  .chip-name { color: var(--success); font-weight: 600; }
  .chip-size { color: var(--text-light); }

  .date-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 14px;
  }
  .date-row label { font-size: 13.5px; font-weight: 500; color: var(--text-mid); white-space: nowrap; }
  .date-row input {
    height: 38px;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0 12px;
    font-family: 'Inter', sans-serif;
    font-size: 13.5px;
    color: var(--text);
    outline: none;
    color-scheme: light;
    transition: border-color 0.15s;
  }
  .date-row input:focus { border-color: var(--orange); }

  /* ‚îÄ‚îÄ Generate ‚îÄ‚îÄ */
  .btn-generate {
    width: 100%;
    height: 50px;
    background: var(--orange);
    color: #fff;
    border: none;
    border-radius: 4px;
    font-family: 'Inter', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 22px;
    transition: all 0.15s;
    letter-spacing: 0.1px;
  }
  .btn-generate:hover:not(:disabled) {
    background: var(--orange-dark);
    box-shadow: 0 4px 14px rgba(232,99,26,0.28);
    transform: translateY(-1px);
  }
  .btn-generate:disabled { opacity: 0.35; cursor: not-allowed; transform: none; box-shadow: none; }

  .spin {
    width: 18px; height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ Status ‚îÄ‚îÄ */
  .status-bar {
    border-radius: 5px;
    padding: 12px 18px;
    margin-bottom: 22px;
    display: none;
    align-items: center;
    gap: 12px;
    font-size: 13.5px;
    font-weight: 500;
  }
  .status-bar.show { display: flex; }
  .status-bar.thinking { background: #f0f4ff; border: 1px solid #c4d0f0; color: #253a90; }
  .status-bar.done     { background: var(--success-bg); border: 1px solid var(--success-bd); color: var(--success); }
  .status-bar.error    { background: #fff4f0; border: 1px solid #f5c4a8; color: #b94a1a; }

  /* ‚îÄ‚îÄ Results ‚îÄ‚îÄ */
  #results { display: none; }
  #results.show { display: block; }

  .results-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 22px;
    flex-wrap: wrap;
    gap: 12px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
  }

  .results-h2 { font-size: 20px; font-weight: 700; color: var(--navy); }
  .results-meta { font-size: 13px; color: var(--text-light); margin-top: 3px; }

  .btn-copy-all {
    height: 38px;
    padding: 0 18px;
    background: var(--navy);
    color: #fff;
    border: none;
    border-radius: 4px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
  }
  .btn-copy-all:hover { background: #263660; }

  /* ‚îÄ‚îÄ Schedule cards ‚îÄ‚îÄ */
  .scard {
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 20px;
    overflow: hidden;
    animation: up 0.3s ease forwards;
    opacity: 0;
    transform: translateY(8px);
  }
  @keyframes up { to { opacity:1; transform:translateY(0); } }
  .scard:nth-child(1){ animation-delay:.04s; }
  .scard:nth-child(2){ animation-delay:.09s; }
  .scard:nth-child(3){ animation-delay:.14s; }
  .scard:nth-child(4){ animation-delay:.19s; }

  .scard-head {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    background: var(--off-white);
    border-bottom: 1px solid var(--border);
  }

  .scard-head.david      { border-left: 4px solid var(--david); }
  .scard-head.karl       { border-left: 4px solid var(--karl);  }
  .scard-head.josh       { border-left: 4px solid var(--josh);  }
  .scard-head.unassigned { border-left: 4px solid var(--unassigned); }

  .av {
    width: 40px; height: 40px;
    border-radius: 5px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 15px;
    color: #fff; flex-shrink: 0;
  }
  .av-david      { background: var(--david); }
  .av-karl       { background: var(--karl); }
  .av-josh       { background: var(--josh); }
  .av-unassigned { background: var(--unassigned); }

  .av-meta { flex: 1; }
  .av-name { font-size: 14px; font-weight: 700; color: var(--navy); }
  .av-role { font-size: 12px; color: var(--text-light); margin-top: 1px; }

  .job-count {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3px 12px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-mid);
  }

  .btn-cp {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-light);
    height: 32px;
    padding: 0 13px;
    border-radius: 4px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-cp:hover { border-color: var(--navy); color: var(--navy); }

  /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
  .tscroll { overflow-x: auto; }

  table { width: 100%; border-collapse: collapse; font-size: 13.5px; }

  thead { background: #fafbfd; }
  thead th {
    padding: 9px 18px;
    text-align: left;
    font-size: 10.5px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-light);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: #fafbfd; }

  tbody td { padding: 12px 18px; vertical-align: top; line-height: 1.5; }

  .seq {
    display: inline-flex; align-items: center; justify-content: center;
    width: 25px; height: 25px;
    border-radius: 4px;
    background: var(--off-white);
    border: 1px solid var(--border);
    font-size: 12px; font-weight: 700;
    color: var(--text-mid);
  }

  .cp { font-weight: 600; color: var(--text); }
  .cs { font-size: 12px; color: var(--text-light); margin-top: 2px; }

  .pill {
    display: inline-block;
    padding: 2px 9px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
  }
  .p-urgent { background: #fff4f0; color: #b94a1a; border: 1px solid #f5c4a8; }
  .p-high   { background: #fff9e6; color: #9a6800; border: 1px solid #f5df9a; }
  .p-sla    { background: var(--success-bg); color: var(--success); border: 1px solid var(--success-bd); }
  .p-normal { background: var(--off-white); color: var(--text-light); border: 1px solid var(--border); }

  /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
  footer {
    background: var(--navy-dark);
    padding: 28px 40px;
  }

  .foot-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
    padding-bottom: 18px;
    border-bottom: 1px solid rgba(255,255,255,0.07);
    margin-bottom: 14px;
  }

  .foot-brand {
    font-size: 14px;
    font-weight: 700;
    color: rgba(255,255,255,0.85);
    letter-spacing: 0.3px;
  }
  .foot-brand span { color: var(--orange); }

  .foot-links { display: flex; gap: 22px; }
  .foot-links a {
    color: rgba(255,255,255,0.4);
    font-size: 12.5px;
    text-decoration: none;
    transition: color 0.15s;
  }
  .foot-links a:hover { color: rgba(255,255,255,0.75); }

  .foot-bottom {
    color: rgba(255,255,255,0.25);
    font-size: 11.5px;
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media(max-width:640px){
    nav { padding: 0 16px; }
    .hero { padding: 28px 16px 24px; }
    .content { padding: 24px 16px 60px; }
    .panel { padding: 18px 16px; }
    .row { flex-direction: column; align-items: stretch; }
    .results-top { flex-direction: column; }
    .nav-right { display: none; }
    .nav-pipe, .nav-pagetitle { display: none; }
    footer { padding: 22px 16px; }
    .foot-links { flex-wrap: wrap; gap: 14px; }
  }
</style>
</head>
<body>

<div class="announce">
  Internal tool &nbsp;¬∑&nbsp; <b>CXI Scheduling Assistant</b> &nbsp;¬∑&nbsp; Authorised team use only
</div>

<nav>
  <div class="nav-brand">
    <div class="logo-mark">
      <!-- Simple CXI shield icon in navy box -->
      <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
        <path d="M11 2L4 5v6c0 4.1 2.97 7.93 7 8.93C15.03 18.93 18 15.1 18 11V5L11 2z" fill="#e8631a"/>
        <text x="11" y="15" text-anchor="middle" font-family="Inter,sans-serif" font-weight="700" font-size="8" fill="white" letter-spacing="0.5">CXI</text>
      </svg>
    </div>
    <div class="logo-text">
      <span class="l1">CXI</span>
      <span class="l2">Control by Integration</span>
    </div>
    <div class="nav-pipe"></div>
    <span class="nav-pagetitle">Scheduling Assistant</span>
  </div>
  <div class="nav-right">
    <a class="nav-phone" href="tel:1300798325">üìû 1300 798 325</a>
    <a class="nav-btn" href="https://cxi.net.au" target="_blank">cxi.net.au ‚Üó</a>
  </div>
</nav>

<div class="hero">
  <div class="hero-inner">
    <div class="hero-label">AroFlo Integration</div>
    <h1 class="hero-h1">Job Scheduling Assistant</h1>
    <p class="hero-p">Upload your AroFlo open task export and generate an optimised daily schedule ‚Äî automatically matched to Karl, Josh and David by skills, location and priority.</p>
  </div>
</div>

<div class="content">

  <!-- API Key -->
  <div class="panel">
    <div class="panel-head">Anthropic API Key</div>
    <div class="row">
      <input class="inp" type="password" id="apiKey" placeholder="sk-ant-api‚Ä¶" autocomplete="off" />
      <button class="btn btn-primary" onclick="saveKey()">Save</button>
      <button class="btn btn-outline" onclick="clearKey()">Clear</button>
    </div>
    <div class="key-note" id="keyNote">
      <span class="dot"></span> No key saved ‚Äî enter your Anthropic API key above
    </div>
  </div>

  <!-- Upload -->
  <div class="panel">
    <div class="panel-head">AroFlo Task Export</div>
    <div class="dropzone" id="dz">
      <input type="file" id="fi" accept=".csv,.xlsx,.xls" onchange="onFile(event)" />
      <span class="dz-icon">üìã</span>
      <div class="dz-title">Click to browse or drag your AroFlo export here</div>
      <div class="dz-hint">Accepts .csv or .xlsx files exported from AroFlo open tasks</div>
    </div>
    <div id="fileChip" style="display:none">
      <div class="file-chip">
        <span>‚úÖ</span>
        <span class="chip-name" id="fName"></span>
        <span class="chip-size" id="fSize"></span>
      </div>
    </div>
    <div class="date-row">
      <label for="schedDate">Schedule date</label>
      <input type="date" id="schedDate" />
    </div>
  </div>

  <button class="btn-generate" id="genBtn" onclick="generate()" disabled>
    Generate Schedule
  </button>

  <div class="status-bar" id="sb">
    <span id="sbIcon"></span>
    <span id="sbText"></span>
  </div>

  <div id="results">
    <div class="results-top">
      <div>
        <div class="results-h2">Schedule Ready</div>
        <div class="results-meta" id="rMeta"></div>
      </div>
      <button class="btn-copy-all" onclick="copyAll()">üìã Copy All</button>
    </div>
    <div id="cards"></div>
  </div>

</div>

<footer>
  <div class="foot-top">
    <div class="foot-brand">CXI &nbsp;<span>Control by Integration</span></div>
    <div class="foot-links">
      <a href="https://cxi.net.au" target="_blank">Website</a>
      <a href="https://cxi.net.au/contact" target="_blank">Contact</a>
      <a href="https://cxi.net.au/support" target="_blank">Support</a>
      <a href="https://cxi.net.au/careers" target="_blank">Careers</a>
    </div>
  </div>
  <div class="foot-bottom">
    ACT Master License: 17502414 &nbsp;|&nbsp; NSW Master License: 104499 &nbsp;|&nbsp; ABN: 37 627 037 521 &nbsp;|&nbsp; Unit 6, 1 Kembla St Fyshwick ACT 2609
  </div>
</footer>

<div style="display:none" id="rawOut"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let fd = null;

window.addEventListener('DOMContentLoaded', () => {
  const k = sessionStorage.getItem('cxi_k');
  if (k) { document.getElementById('apiKey').value = k; setKeyOk(true); }
  document.getElementById('schedDate').value = new Date().toISOString().split('T')[0];
  chkBtn();
  const dz = document.getElementById('dz');
  dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('over'));
  dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('over'); if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]); });
});

function saveKey() {
  const v = document.getElementById('apiKey').value.trim();
  if (!v.startsWith('sk-ant-')) { alert('Key should start with sk-ant-'); return; }
  sessionStorage.setItem('cxi_k', v); setKeyOk(true); chkBtn();
}
function clearKey() {
  sessionStorage.removeItem('cxi_k'); document.getElementById('apiKey').value = ''; setKeyOk(false); chkBtn();
}
function setKeyOk(ok) {
  const el = document.getElementById('keyNote');
  el.className = 'key-note' + (ok ? ' ok' : '');
  el.innerHTML = `<span class="dot"></span> ${ok ? 'API key saved for this session' : 'No key saved ‚Äî enter your Anthropic API key above'}`;
}

function onFile(e) { if (e.target.files[0]) loadFile(e.target.files[0]); }
function loadFile(f) {
  const sz = f.size < 1024 ? f.size+' B' : (f.size/1024).toFixed(1)+' KB';
  const r = new FileReader();
  if (/\.csv$/i.test(f.name)) {
    r.onload = e => { fd = e.target.result; showChip(f.name, sz); };
    r.readAsText(f);
  } else {
    r.onload = e => {
      try { const wb = XLSX.read(e.target.result,{type:'array'}); fd = XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]); showChip(f.name, sz); }
      catch { alert('Could not read file. Try exporting as CSV from AroFlo.'); }
    };
    r.readAsArrayBuffer(f);
  }
}
function showChip(n, s) {
  document.getElementById('fileChip').style.display = 'block';
  document.getElementById('fName').textContent = n;
  document.getElementById('fSize').textContent = s;
  chkBtn();
}
function chkBtn() {
  document.getElementById('genBtn').disabled = !(sessionStorage.getItem('cxi_k') && fd);
}

async function generate() {
  const key = sessionStorage.getItem('cxi_k');
  const raw = document.getElementById('schedDate').value;
  const dl  = raw ? new Date(raw+'T00:00:00').toLocaleDateString('en-AU',{weekday:'long',day:'numeric',month:'long',year:'numeric'}) : 'Today';

  setSb('thinking', null, 'Analysing jobs and building optimised schedule‚Ä¶');
  document.getElementById('genBtn').disabled = true;
  document.getElementById('results').classList.remove('show');

  const SYS = `You are the CXI AroFlo Scheduling Assistant for Control by Integration, a Canberra electronic security company. Read the open task export and assign each job to the best technician using the rules below.

TECHNICIAN PROFILES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

DAVID ‚Äî Senior Technician (highest experience)
‚Ä¢ Knows almost everything ‚Äî first choice for all complex, specialist or high-stakes jobs
‚Ä¢ Skills: Inner Range Inception, Inner Range Integriti (advanced), Intercoms (all), CCTV (all), NX Witness, Prot√©g√© WX, QPRC / Queanbeyan Palerang Regional Council sites, complex troubleshooting
‚Ä¢ Certifications: Integriti Advanced, NCH (North Canberra Hospital), TCH (The Canberra Hospital)
‚Ä¢ Zone preference: ACT North Side  |  Hours: 08:00‚Äì16:30

KARL ‚Äî Intermediate Technician
‚Ä¢ Good with most things ‚Äî suitable for standard and moderately complex jobs
‚Ä¢ Skills: Inner Range Inception, Inner Range Integriti, Intercoms (all), CCTV (all), NX Witness, Prot√©g√© WX, Prot√©g√© GX, standard troubleshooting
‚Ä¢ Certifications: Integriti Base Level
‚Ä¢ Zone: ACT  |  Hours: 08:00‚Äì16:30

JOSH ‚Äî Junior Technician (least experienced)
‚Ä¢ Basic tasks only ‚Äî do NOT assign complex or specialist work to Josh
‚Ä¢ Skills: Inner Range Inception, Hikvision CCTV (basic), basic CCTV, NX Witness (basic), cabling, installation, basic troubleshooting
‚Ä¢ Certifications: Inner Range Inception, Prot√©g√© WX, NCH and TCH site access
‚Ä¢ Zone: ACT  |  Hours: 08:00‚Äì16:30

ASSIGNMENT RULES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Integriti jobs ‚Üí David or Karl only (David preferred for advanced)
‚Ä¢ Advanced CCTV ‚Üí David or Karl only
‚Ä¢ Prot√©g√© GX ‚Üí Karl only
‚Ä¢ QPRC / Queanbeyan Palerang Regional Council ‚Üí David only
‚Ä¢ NCH (North Canberra Hospital) ‚Üí David or Josh only
‚Ä¢ TCH (The Canberra Hospital) ‚Üí David or Josh only
‚Ä¢ Intercoms ‚Üí David or Karl only (Josh not qualified)
‚Ä¢ Complex troubleshooting ‚Üí David first, Karl second, never Josh
‚Ä¢ Basic cabling / installation ‚Üí any tech including Josh
‚Ä¢ Basic CCTV footage review ‚Üí any tech including Josh
‚Ä¢ Never assign a job above a tech's experience level
‚Ä¢ If no qualified tech available ‚Üí Unassigned with reason

EXPERIENCE MATCHING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ David: complex, multi-system, specialist, senior troubleshooting
‚Ä¢ Karl: standard installs, single systems, intermediate troubleshooting
‚Ä¢ Josh: basic tasks, cabling, simple installs only

GEOGRAPHIC RULES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ David finishes on ACT North Side where possible
‚Ä¢ Group each tech's jobs in geographic clusters (5‚Äì10 km radius)
‚Ä¢ Sequence to minimise travel and backtracking
‚Ä¢ SLA / Urgent jobs override geographic preference

WORKLOAD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Max 6 jobs per tech per day
‚Ä¢ Max 30 min travel between consecutive jobs
‚Ä¢ Overflow to Unassigned if workload exceeded

PRIORITY ORDER: SLA ‚Üí Urgent ‚Üí High ‚Üí Normal
SLA and Urgent always scheduled first.

OUTPUT: Reply with raw JSON only. No markdown, no explanation.

{
  "scheduleDate": "string",
  "summary": "brief one-line summary",
  "technicians": [
    {
      "name": "David",
      "role": "Senior Technician",
      "jobs": [
        {
          "order": 1,
          "taskId": "string",
          "client": "string",
          "location": "string",
          "description": "string",
          "priority": "Urgent|High|SLA|Normal",
          "estimatedDuration": "string",
          "notes": "string"
        }
      ]
    }
  ],
  "unassigned": [
    { "taskId": "string", "client": "string", "location": "string", "description": "string", "reason": "string" }
  ]
}
Only include technicians with at least one job. Always include unassigned array (empty if none).`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-opus-4-5-20251101',
        max_tokens: 4096,
        system: SYS,
        messages: [{ role: 'user', content: `Schedule these AroFlo tasks for ${dl}. Apply all rules.\n\n${fd}` }]
      })
    });

    if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message||'API error'); }
    const data = await res.json();
    let sched;
    try { sched = JSON.parse(data.content[0].text.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim()); }
    catch { throw new Error('Could not parse response ‚Äî please try again.'); }

    setSb('done', '‚úÖ', `Schedule generated for ${dl}`);
    render(sched, dl);
  } catch(err) {
    setSb('error', '‚ùå', 'Error: '+err.message);
    document.getElementById('genBtn').disabled = false;
  }
}

function setSb(type, icon, text) {
  const sb = document.getElementById('sb');
  sb.className = 'status-bar show '+type;
  document.getElementById('sbIcon').innerHTML = type==='thinking' ? '<div class="spin"></div>' : (icon||'');
  document.getElementById('sbText').textContent = text;
}

function render(s, dl) {
  const total = (s.technicians||[]).reduce((a,t)=>a+t.jobs.length,0);
  const unlen = (s.unassigned||[]).length;
  document.getElementById('rMeta').textContent = `${dl}  ¬∑  ${total} job${total!==1?'s':''} assigned  ¬∑  ${unlen} unassigned`;

  const wrap = document.getElementById('cards');
  wrap.innerHTML = '';

  const TM = {
    David: {cls:'david', av:'av-david', role:'Senior Technician'},
    Karl:  {cls:'karl',  av:'av-karl',  role:'Intermediate Technician'},
    Josh:  {cls:'josh',  av:'av-josh',  role:'Junior Technician'}
  };

  (s.technicians||[]).forEach(tech => {
    const m = TM[tech.name]||{cls:'karl',av:'av-karl',role:''};
    const rows = tech.jobs.map(j => {
      const pc = {Urgent:'p-urgent',High:'p-high',SLA:'p-sla',Normal:'p-normal'}[j.priority]||'p-normal';
      return `<tr>
        <td><span class="seq">${j.order}</span></td>
        <td><div class="cp">${x(j.taskId)}</div><div class="cs">${x(j.estimatedDuration)}</div></td>
        <td><div class="cp">${x(j.client)}</div><div class="cs">${x(j.location)}</div></td>
        <td>${x(j.description)}</td>
        <td><span class="pill ${pc}">${x(j.priority||'Normal')}</span></td>
        <td class="cs">${x(j.notes||'‚Äî')}</td>
      </tr>`;
    }).join('');

    const el = document.createElement('div');
    el.className = 'scard';
    el.innerHTML = `
      <div class="scard-head ${m.cls}">
        <div class="av ${m.av}">${tech.name.charAt(0)}</div>
        <div class="av-meta">
          <div class="av-name">${x(tech.name)}</div>
          <div class="av-role">${x(tech.role||m.role)}</div>
        </div>
        <div class="job-count">${tech.jobs.length} job${tech.jobs.length!==1?'s':''}</div>
        <button class="btn-cp" onclick="copyCard('${x(tech.name)}')">üìã Copy</button>
      </div>
      <div class="tscroll"><table>
        <thead><tr><th>#</th><th>Task ID</th><th>Client / Location</th><th>Description</th><th>Priority</th><th>Notes</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
    wrap.appendChild(el);
  });

  if (s.unassigned?.length) {
    const rows = s.unassigned.map(j=>`<tr>
      <td><div class="cp">${x(j.taskId)}</div></td>
      <td><div class="cp">${x(j.client)}</div><div class="cs">${x(j.location)}</div></td>
      <td>${x(j.description)}</td>
      <td style="color:var(--orange);font-size:13px">${x(j.reason)}</td>
    </tr>`).join('');
    const el = document.createElement('div');
    el.className = 'scard';
    el.innerHTML = `
      <div class="scard-head unassigned">
        <div class="av av-unassigned">!</div>
        <div class="av-meta">
          <div class="av-name">Unassigned Jobs</div>
          <div class="av-role">Could not be scheduled</div>
        </div>
        <div class="job-count">${s.unassigned.length} job${s.unassigned.length!==1?'s':''}</div>
        <button class="btn-cp" onclick="copyCard('Unassigned')">üìã Copy</button>
      </div>
      <div class="tscroll"><table>
        <thead><tr><th>Task ID</th><th>Client / Location</th><th>Description</th><th>Reason Unassigned</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
    wrap.appendChild(el);
  }

  buildRaw(s, dl);
  document.getElementById('results').classList.add('show');
  document.getElementById('genBtn').disabled = false;
  document.getElementById('genBtn').innerHTML = '‚Ü∫ &nbsp;Generate New Schedule';
  document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
}

function buildRaw(s, dl) {
  let t = `CXI SCHEDULE ‚Äî ${dl}\n${'‚ïê'.repeat(60)}\n\n`;
  (s.technicians||[]).forEach(tech => {
    t += `${tech.name.toUpperCase()} ‚Äî ${tech.role||''}\n${'‚îÄ'.repeat(40)}\n`;
    t += `#\tTask ID\tClient\tLocation\tDescription\tPriority\tNotes\n`;
    tech.jobs.forEach(j => t += `${j.order}\t${j.taskId||''}\t${j.client||''}\t${j.location||''}\t${j.description||''}\t${j.priority||''}\t${j.notes||''}\n`);
    t += '\n';
  });
  if (s.unassigned?.length) {
    t += `UNASSIGNED\n${'‚îÄ'.repeat(40)}\n`;
    t += `Task ID\tClient\tLocation\tDescription\tReason\n`;
    s.unassigned.forEach(j => t += `${j.taskId||''}\t${j.client||''}\t${j.location||''}\t${j.description||''}\t${j.reason||''}\n`);
  }
  document.getElementById('rawOut').textContent = t;
}

function copyAll() {
  navigator.clipboard.writeText(document.getElementById('rawOut').textContent).then(() => {
    const b = document.querySelector('.btn-copy-all');
    b.textContent = '‚úÖ Copied!';
    setTimeout(()=>b.textContent='üìã Copy All',2000);
  });
}

function copyCard(name) {
  const lines = document.getElementById('rawOut').textContent.split('\n');
  const others = ['DAVID','KARL','JOSH','UNASSIGNED'].filter(n=>n!==name.toUpperCase());
  let out=[], on=false;
  for (const l of lines) {
    if (l.startsWith(name.toUpperCase())) on=true;
    if (on) {
      if (others.some(n=>l.startsWith(n)) && out.length>0) break;
      if (l.startsWith('‚ïê') && out.length>0) break;
      out.push(l);
    }
  }
  navigator.clipboard.writeText(out.join('\n')).then(() => {
    document.querySelectorAll('.btn-cp').forEach(b => {
      if (b.getAttribute('onclick')?.includes(name)) {
        b.textContent='‚úÖ Copied!'; setTimeout(()=>b.textContent='üìã Copy',2000);
      }
    });
  });
}

function x(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
